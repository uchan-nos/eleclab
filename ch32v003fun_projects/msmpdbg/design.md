## システム構成

デバッグ対象機器（Target） <--> MSMP-DBG（Dbg）

- IN: Dbg の入力（J1 コネクタ）の信号ピン
- OUT: Dbg の出力（J2 コネクタ）の信号ピン

## イベントリスト

- 事象：Target がメッセージ送信
  - 刺激：IN にスタートビット検出（メッセージ先頭）
  - 行動：メッセージをメモリへ記録
    - 送受信同時デバッグモードが ON なら、スタートビット検出の直後からメッセージ送信
  - 応答：なし
    - 送受信同時デバッグモードが ON なら、OUT にメッセージ送出
  - 影響：メッセージがメモリへ記録される
    - 送受信同時デバッグモードが ON なら、Target はメッセージ送受信が同時に起こる
- 事象：送受信同時デバッグモード設定要求
  - 刺激：送受信同時デバッグモード設定開始
  - 行動：送受信同時デバッグモードを指定された状態（ON/OFF）に設定する
  - 応答：なし
  - 影響：送受信同時デバッグモードの ON/OFF が設定される
- 事象：メモリ表示要求
  - 刺激：メモリ表示開始
  - 行動：メモリに記録された全てのメッセージを表示
  - 応答：UART（U2）へメッセージを送信
  - 影響：シリアルターミナルに複数のメッセージが表示される
- 事象：メッセージ送出要求
  - 刺激：メッセージ送出開始
  - 行動：事前設定されたメッセージを Target へ送信
  - 応答：OUT に立ち下がりエッジ
  - 影響：Target でメッセージが受信される
- 事象：メッセージ設定要求
  - 刺激：メッセージ設定開始
  - 行動：指定されたメッセージを Dbg のメモリへ記録
  - 応答：UART（U2）へ設定完了を送信
  - 影響：次回以降に送出するメッセージを設定できる
- 事象：メッセージ記録・表示要求
  - 刺激：メッセージ記録・表示開始
  - 行動：トリガを受けてメッセージを受信し、メッセージが受信し終わるかメモリが満杯になったら表示
  - 応答：UART（U2）へメッセージを送信
  - 影響：メッセージが来るまでコマンド受け付け停止、シリアルターミナルにメッセージが表示される
- 事象：波形記録・表示要求
  - 刺激：波形記録・表示開始
  - 行動：トリガを受けてメッセージを受信し波形を記録し、メッセージが受信し終わるかメモリが満杯になったら波形を表示
  - 応答：UART（U2）へ波形テキストを送信
  - 影響：メッセージが来るまでコマンド受け付け停止、シリアルターミナルに波形が表示される

## RAM

CH32V203K8T6: 64KB Flash, 20KB RAM

- メッセージメモリ：1KiB
  - ひとつのメッセージは最大 65B
  - メタデータ含め、1 メッセージ 128B で格納するとすれば、1KiB で 8 メッセージ
- 波形メモリ：17KiB

## 波形の記録とクロック周波数

MSMP 信号は 9600bps の UART だが、1 バイトごとに 20ms 程度の時間待ちを行う。
したがって、固定の時間間隔で波形を記録するのは無駄が大きい（おおくの時間は固定で 1 が記録されてしまう）。

そこで、信号が変化した時刻のリストとして表現する。
信号変化が非常に激しい場合を除き、データ量を削減できる。
時刻はトリガ時点を 0 とし、9.6kHz の 10 倍程度の分解能を持てばいいだろう。
したがって 96KHz でカウントアップする整数とする。

1 メッセージ 65B を 20ms 間隔で受信する場合、1.3 秒かかる。
96KHz でカウントアップすると、1.3 秒では 124800。
16 ビット整数では収まらない。したがって時刻は 32 ビット整数とする。

17KiB を時刻の配列として考えると 4352 要素が格納できる。
1 バイトあたり最大で 10 回の信号変化が起こるため、65B では 650 回。
4352 / 650 = 6.7 ということで、6 メッセージ分はバッファに格納可能。

CH32V203 の内蔵オシレータ HSI は 8MHz で、PLL を使って 2, 3, ..., 15, 16, 18 倍を選択できる。
幸い、8000×3 / 96 = 250.0 とぴったりなので、PLL を 3 の倍数にすると良い。
将来的に USB 機能を使いたくなったら 48MHz, 96MHz, 144MHz のいずれかである必要があるから、48MHz を選択することにする。
500 クロックごとに時刻をカウントアップし、波形を取り込めば良い。
