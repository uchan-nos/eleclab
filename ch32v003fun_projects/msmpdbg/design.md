# システム構成

デバッグ対象機器（Target） <--> MSMP-DBG（Dbg）

- IN: Dbg の入力（J1 コネクタ）の信号ピン
- OUT: Dbg の出力（J2 コネクタ）の信号ピン

# 機能要求

実際に試作品を作って実用した経験から、欲しい機能を優先度順に挙げる。

1. MSMP デバッガ自体のデバッグ支援機能
   - 製作する過程におけるデバッグで必要
   - Target としてパソコン（USB-UART 変換モジュール）を接続したい
2. 指定したメッセージを送る機能
3. 直前に送信したメッセージを再度送る機能
4. 経路の途中に挿入して流れてるメッセージを確認する機能

# イベントリスト

- 事象：Target がメッセージ送信
  - 刺激：IN にスタートビット検出（メッセージ先頭）
  - 行動：メッセージをメモリへ記録
    - 送受信同時デバッグモードが ON なら、スタートビット検出の直後からメッセージ送信
  - 応答：なし
    - 送受信同時デバッグモードが ON なら、OUT にメッセージ送出
  - 影響：メッセージがメモリへ記録される
    - 送受信同時デバッグモードが ON なら、Target はメッセージ送受信が同時に起こる
- 事象：送受信同時デバッグモード設定要求
  - 刺激：送受信同時デバッグモード設定開始
  - 行動：送受信同時デバッグモードを指定された状態（ON/OFF）に設定する
  - 応答：なし
  - 影響：送受信同時デバッグモードの ON/OFF が設定される
- 事象：メモリ表示要求
  - 刺激：メモリ表示開始
  - 行動：メモリに記録された全てのメッセージを表示
  - 応答：UART（U2）へメッセージを送信
  - 影響：シリアルターミナルに複数のメッセージが表示される
- 事象：メッセージ送出要求
  - 刺激：メッセージ送出開始
  - 行動：事前設定されたメッセージを Target へ送信
  - 応答：OUT に立ち下がりエッジ
  - 影響：Target でメッセージが受信される
- 事象：メッセージ設定要求
  - 刺激：メッセージ設定開始
  - 行動：指定されたメッセージを Dbg のメモリへ記録
  - 応答：UART（U2）へ設定完了を送信
  - 影響：次回以降に送出するメッセージを設定できる
- 事象：メッセージ記録・表示要求
  - 刺激：メッセージ記録・表示開始
  - 行動：トリガを受けてメッセージを受信し、メッセージが受信し終わるかメモリが満杯になったら表示
  - 応答：UART（U2）へメッセージを送信
  - 影響：メッセージが来るまでコマンド受け付け停止、シリアルターミナルにメッセージが表示される
- 事象：波形記録・表示要求
  - 刺激：波形記録・表示開始
  - 行動：トリガを受けてメッセージを受信し波形を記録し、メッセージが受信し終わるかメモリが満杯になったら波形を表示
  - 応答：UART（U2）へ波形テキストを送信
  - 影響：メッセージが来るまでコマンド受け付け停止、シリアルターミナルに波形が表示される

# RAM

CH32V003J4M6: 16KB Flash, 2KB RAM

- メッセージメモリ：128B
  - ひとつのメッセージは最大 65B
  - しかし、実際に送受信するメッセージの多くはもっと短く、10B 程度で十分か
  - メタデータ含め、1 メッセージ 16B で格納するとすれば、128B で 8 メッセージ
- 波形メモリ：256B

# 波形の記録とクロック周波数

MSMP 信号は 9600bps の UART だが、1 バイトごとに 20ms 程度の時間待ちを行う。
したがって、固定の時間間隔で波形を記録するのは無駄が大きい（おおくの時間は固定で 1 が記録されてしまう）。

そこで、信号が変化した時刻のリストとして表現する。
信号変化が非常に激しい場合を除き、データ量を削減できる。
時刻はトリガ時点を 0 とし、9.6kHz の 10 倍程度の分解能を持てばいいだろう。
したがって 96KHz でカウントアップする整数とする。

リストに含まれる時刻は単調増加であるから、直前の時刻からの経過時間にするとデータ量を削減可能。
16 ビットのうち最上位ビットを「継続フラグ」として使い、残り 15 ビットで時刻差分を表現するとする。
32767 / 96000 = 341ms なので、通常の時間待ち 20ms であれば十分に表現可能。
341ms を超える経過時間を表現したい場合、「継続フラグ」を 1 にすることで表現する。

256B を時刻の配列として考えると 128 要素が格納できる。
1 バイトあたり最大で 10 回の信号変化が起こるため、128 回は 12 バイト分。
先頭 12 バイト分の波形が記録できれば簡易な確認には十分だろう。

CH32V203 の内蔵オシレータ HSI は 8MHz で、PLL を使って 2, 3, ..., 15, 16, 18 倍を選択できる。
幸い、8000×3 / 96 = 250.0 とぴったり割り切れるので、PLL を 3 の倍数にすると良い。
将来的に USB 機能を使いたくなったら 48MHz, 96MHz, 144MHz のいずれかである必要があるから、48MHz を選択することにする。
500 クロックごとに時刻をカウントアップし、波形を取り込めば良い。

# 周辺機能の用途

| 周辺機能名 | 用途                                   |
|------------|----------------------------------------|
| TIM2       | MSMP 信号を記録するための定期タイマー  |
| TIM3       | MSMP 送信タイミング（20ms 間隔）の生成 |
| USART1     | MSMP 通信                              |
| USART2     | PC との通信                            |

# モジュール設計

## msmpdbg.c: メインモジュール

### 公開インターフェース

| 関数名        | 責務                                          |
| ------------- | --------------------------------------------- |
| main          | 周辺機能の初期化、PC からのコマンド受信と実行 |
| ProcCommand   | コマンド実行                                  |
| X_Init        | 周辺機能の初期化                              |
| X_IRQHandler  | 周辺機能の割り込み処理                        |
| StartTransmit | MSMP ターゲットにメッセージ送信開始           |

| 変数名                   | 責務                         |
| ------------------------ | ---------------------------- |
| tick                     | 現在時刻                     |
| transmit_on_receive_mode | 送受信同時デバッグモード     |
| transmit_msg             | 送信メッセージ               |
| transmit_period_ms       | MSMP 送信間隔（初期値 20ms） |

## msmp_recorder.c: MSMP 通信の記録

### 公開インターフェース

| 関数名      | 責務                                                                                  |
| ----------- | ------------------------------------------------------------------------------------- |
| SenseSignal | 受信信号を一定間隔で記録、MSMP メッセージ先頭のスタートビットを受信したかどうかを判定 |
| PlotSignal  | 記録した信号をグラフ表示                                                              |
| ProcByte    | 受信した 1 バイトを処理（バッファ追加や受信ステート更新）                             |

| 変数名          | 責務                                                      |
| --------------- | --------------------------------------------------------- |
| msmp_state      | MSMP 受信ステート（先頭バイト受信待ち、メッセージ受信中） |
| msmp_flags      | MSMP 受信に関連する各種フラグ                             |
| msg_buf         | 受信した MSMP メッセージの列                              |
| msg_wpos        | `msg_buf` の書き込み位置                                  |
| msg_body_wpos   | `msg_buf[msg_wpos].body` の書き込み位置                   |
| sig_buf         | 受信信号が反転したときの時刻の列                          |
| sig_wpos        | `sig_buf` の書き込み位置                                  |
| sig_record_mode | 真なら受信信号を記録する                                  |

#### msmp_flags

| ビット位置 | 意味                         |
| ---------- | ---------------------------- |
| 0          | 自ホスト宛メッセージを受信中 |
| 1          | 転送メッセージを受信中       |

# 関数の動作関係

## TIM2_IRQHandler

MSMP のボーレートより高い周波数（通常は 10 倍）で呼び出される。

- 毎回 SenseSignal を呼び出す。
- SenseSignal が真（MSMP メッセージ先頭である）を返した場合、StartTransmit を呼び出す。
  - これにより、メッセージ先頭の 1 バイトの受信が完了する前に返信を開始できる。
